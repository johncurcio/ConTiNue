<!-- views/dashboard -->

<%- include('partials/head') %>

<div class="container">
    <%- include('partials/header') %>

    <div>
    	<form id="edit-story" method="post">
        	<p><input class="edit-title" name="title" value="<%= story.title %>"/></p>
        	<textarea  class="edit-synopsis" name="synopsis"><%= story.synopsis %></textarea>
        	<p><input class="edit-genre"  name="genre" value="<%= story.genre %>"/></p>
        	<p>história criada por <a href="/profile/<%=story.author._id%>"><%= story.author.local.username %>	</a></p>
        	<div class="pull-right">
        		<button type="submit"  formaction="/story/<%= id %>/dashboard/closeStory" class = 'btn btn-info btn-xs'>arquivar história</button>
        	    <button type="submit" class = 'btn btn-success btn-xs' formaction="/story/<%= id %>/dashboard/updateStory">salvar mudanças</button>
        	    <button type="submit"  formaction="/story/<%= id %>/dashboard/deleteStory" class = 'btn btn-danger btn-xs'>deletar história</button>
        	</div>
    	</form>
        <ul class="nav nav-tabs">
            <li><a class="nav-link" href="/story/<%= id %>">Fragmentos</a></li>
            <li><a class="nav-link" href="/story/<%= id %>/compiledStory">Compilar Fragmentos</a></li>
            <li class="active"><a class="nav-link active" href="/story/<%= id %>/dashboard">Dashboard</a></li>
        </ul>

        <div class="container-fluid panel panel-default">
          <% story.fragments.forEach((fragment) => { %>
          <%
             var monthNames = [
                  "Janeiro", "Fevereiro", "Março",
                  "Abril", "Maio", "Junho", "Julho",
                  "Agosto", "Setembro", "Outubro",
                  "Novembro", "Dezembro"
               ];
             var d = fragment.createdat.getDate();
             var m = monthNames[fragment.createdat.getMonth()];
             var y = fragment.createdat.getFullYear();
             var modd = fragment.modifieddat.getDate();
             var modm = monthNames[fragment.modifieddat.getMonth()];
             var mody = fragment.modifieddat.getFullYear();
           %>
          <div class="row fragment">
            <a href="/story/<%=id%>#<%=fragment._id%>"></a>
            <div class="col-sm-10 col-xs-10">  
                <div class="">
                  <div class="panel-body">
                    <p><%- fragment.data %></p>
                    <p>
                      <small><small>Adicionado em: </small> <%= d+ ' de '  +m+ ' de ' +y %></small>
                      <small>por</small> 
                      <object>
                      <a href="/profile/<%=fragment.author._id%>"><%= fragment.author.local.username %></a>
                    </object>
                    </p>
                    <p>
                      <small><small>Modificado da última vez em: </small> <%= modd+ ' de '  +modm+ ' de ' +mody %></small>
                    </object>
                    </p>
                  </div>
                </div>        
            </div><!--/col-->
            <div class="col-sm-2 col-xs-2">
              <div class="pull-right">
                <div class="panel-body">
                  <a id='editar<%=fragment._id%>' href="#editor" class = 'label label-info'>
                  	editar
                  </a>
                  <a id='deletar' href="/story/<%= id %>/dashboard/deleteFragment/<%=fragment._id%>" class = 'label label-warning'>deletar</a>
                  <script type="text/javascript">
                  	$(document).ready(function(){
                  		$("#editar<%=fragment._id%>").click(function() {
						  $(".ql-editor").empty().html('<%-fragment.data%>');
						  $("#fragment-editor").attr('action', '/story/<%= id %>/dashboard/updateFragment/<%=fragment._id%>');
						});
                  	});
                  </script>
                </div>
              </div>
            </div>

          </div>
          <hr>
        <% }) %>
    	</div>
    	<a href="#editor"></a>
    	<div class="row">
    	  <div class="col-sm-11 col-xs-11 add-fragment"> 
    	    <div id="form-container">
    	      <form id="fragment-editor" name="q-editor" action="/story/<%= id %>/updateFragment/" method="post">
    	        <div class="row form-group">
    	          <input name="data" type="hidden">
    	          <div id="editor"></div>
    	        </div>
    	        <button type="submit" class="btn btn-info btn-sm pull-right">Salvar Mudanças</button>
    	      </form>
    	    </div>
    	    <script src="../../editor.js"></script>
    	  </div>
    	</div>
    </div>
</div>

<%- include('partials/footer') %>